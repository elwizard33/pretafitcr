---
import { plans } from '../../data/plansCrossFit';

// Validate plans data with fallback
let validatedPlans;
try {
  validatedPlans = plans;
  if (!validatedPlans || !Array.isArray(validatedPlans) || validatedPlans.length === 0) {
    throw new Error('Invalid or empty plans data');
  }
} catch (error) {
  console.error('Error loading plans:', error);
  // Provide fallback plan data
  validatedPlans = [
    {
      id: 'fallback-plan',
      name: 'Plan Básico',
      price: 'Consultar',
      sessionsPerWeek: 'Flexible',
      validity: 'A convenir',
      popular: false
    }
  ];
}
---

<section id="plans" class="section" aria-labelledby="plans-heading">
  <div class="container">
    <div class="overline">Membresías</div>
    <h2 id="plans-heading" class="h2">Planes y Precios</h2>
    
    {validatedPlans && validatedPlans.length > 0 ? (
      <div class="bg-card border border-line rounded-[14px] overflow-hidden mt-8 shadow-custom">
        <table class="w-full border-collapse" role="table" aria-labelledby="plans-heading" 
               aria-describedby="plans-description">
          <caption class="sr-only" id="plans-description">
            Tabla de planes de membresía de CrossFit con precios, número de reservaciones por semana y validez
          </caption>
          <thead class="bg-slate-50 border-b border-line">
            <tr>
              <th scope="col" class="p-4 text-left font-bold text-ink text-sm uppercase tracking-wider">Plan</th>
              <th scope="col" class="p-4 text-left font-bold text-ink text-sm uppercase tracking-wider">Precio</th>
              <th scope="col" class="p-4 text-left font-bold text-ink text-sm uppercase tracking-wider">Reservaciones</th>
              <th scope="col" class="p-4 text-left font-bold text-ink text-sm uppercase tracking-wider">Validez</th>
            </tr>
          </thead>
          <tbody class="max-md:flex max-md:flex-col max-md:gap-4 max-md:p-4">
            {validatedPlans.map((plan, index) => (
              <tr class={`plan-row border-b border-slate-100 last:border-b-0 
                         max-md:block max-md:bg-card max-md:border max-md:border-line max-md:rounded-[10px] max-md:p-4 max-md:shadow-sm
                         ${plan.popular ? 'bg-orange-50 border-l-2 border-l-brand max-md:border-l-0 max-md:border max-md:border-brand max-md:shadow-[0_2px_8px_rgba(255,106,42,0.15)]' : ''}`} 
                  data-popular={plan.popular} 
                  aria-describedby={plan.popular ? `popular-${index}` : undefined}>
                <td data-label="Plan" class="p-4 border-b border-slate-100 text-muted align-top last:border-b-0
                                           max-md:border-none max-md:p-2 max-md:flex max-md:justify-between max-md:items-center
                                           max-md:before:content-[attr(data-label)':'] max-md:before:font-semibold max-md:before:text-ink max-md:before:flex-shrink-0 max-md:before:min-w-[120px]">
                  <div class="flex items-center gap-2 font-semibold text-ink max-md:flex-col max-md:items-start max-md:gap-1">
                    {plan.name || 'Plan no disponible'}
                    {plan.popular && (
                      <span class="bg-brand text-white text-xs font-bold px-2 py-1 rounded-full uppercase tracking-wider max-sm:text-[10px] max-sm:px-1.5 max-sm:py-0.5" 
                            id={`popular-${index}`} 
                            aria-label="Plan más popular">Popular</span>
                    )}
                  </div>
                </td>
                <td data-label="Precio" class="p-4 border-b border-slate-100 text-muted align-top last:border-b-0
                                              max-md:border-none max-md:p-2 max-md:flex max-md:justify-between max-md:items-center
                                              max-md:before:content-[attr(data-label)':'] max-md:before:font-semibold max-md:before:text-ink max-md:before:flex-shrink-0 max-md:before:min-w-[120px]">
                  <span class="font-bold text-lg text-ink">${plan.price || 'Consultar'}</span>
                </td>
                <td data-label="Reservaciones" class="p-4 border-b border-slate-100 text-muted align-top last:border-b-0
                                                     max-md:border-none max-md:p-2 max-md:flex max-md:justify-between max-md:items-center
                                                     max-md:before:content-[attr(data-label)':'] max-md:before:font-semibold max-md:before:text-ink max-md:before:flex-shrink-0 max-md:before:min-w-[120px]">
                  {plan.sessionsPerWeek || 'Flexible'} por semana
                </td>
                <td data-label="Validez" class="p-4 border-b border-slate-100 text-muted align-top last:border-b-0
                                               max-md:border-none max-md:p-2 max-md:flex max-md:justify-between max-md:items-center
                                               max-md:before:content-[attr(data-label)':'] max-md:before:font-semibold max-md:before:text-ink max-md:before:flex-shrink-0 max-md:before:min-w-[120px]">
                  {plan.validity || 'A convenir'}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
        
        <!-- Mobile-specific hidden thead for accessibility -->
        <thead class="hidden max-md:absolute max-md:-top-[9999px] max-md:-left-[9999px]">
          <tr>
            <th scope="col">Plan</th>
            <th scope="col">Precio</th>
            <th scope="col">Reservaciones</th>
            <th scope="col">Validez</th>
          </tr>
        </thead>
      </div>
    ) : (
      <div class="text-center py-12 px-8 bg-card border border-line rounded-[14px] text-muted" role="alert" aria-live="polite">
        <div class="mb-4 opacity-60" aria-hidden="true">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" role="img" 
               aria-label="Icono de información">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#e5e7eb"/>
          </svg>
        </div>
        <h3 class="mb-2 text-ink text-xl font-medium">Planes no disponibles</h3>
        <p class="mb-6 text-sm leading-relaxed">Por favor contactanos para conocer nuestros planes y precios actualizados.</p>
        <a href="tel:+50670092140" 
           class="inline-flex items-center gap-2 bg-brand text-white no-underline py-3 px-6 rounded-full font-semibold transition-all duration-200 hover:bg-brand-600 hover:-translate-y-0.5" 
           aria-label="Llamar al teléfono +506 7009-2140 para consultar planes">
          Llamar +506 7009-2140
        </a>
      </div>
    )}
  </div>
</section>
